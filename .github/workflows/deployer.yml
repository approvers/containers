name: Deployer

on:
  push:
    branches:
      - master

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2

    - name: Copy Secrets as .env
      env:
        NGINX_EXAMPLE_TOKEN: ${{ secrets.EXAMPLE_TOKEN }}
      run: |
        for DIRECTORY in */; do
          cd $DIRECTORY
          printenv | grep "^$(echo $DIRECTORY | sed 's/\///' | tr '[a-z]' '[A-Z]')_" > ./.env
          cd ..
        done

    - uses: approvers/containers-deployer@v0.3.0
      with:
        ssh_host: ${{ secrets.SSH_HOST }}
        ssh_port: ${{ secrets.SSH_PORT }}
        ssh_user: ${{ secrets.SSH_USER }}
        ssh_key: ${{ secrets.SSH_KEY }}
